<!DOCTYPE html>
<html lang="en">
<head>
    <title>MongoDB</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="../ShowerTemplate/shower/themes/ribbon/styles/styles.css">
    <style>
        .shower {
            --slide-ratio: calc(16 / 9);
        }
    </style>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async
            src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js">
    </script>
</head>
<body class="shower list">

    <header class="caption">
        <h1>MongoDB</h1>
        <p>Mikel Egaña Aranguren</p>
    </header>

    <section class="slide" id="cover">
        <h2>MongoDB</h2>
        <p>Mikel Egaña Aranguren</p>
        <p><a href="https://mikel-egana-aranguren.github.io/">mikel-egana-aranguren.github.io</a></p>
        <p><a href="mailto:mikel.egana@ehu.eus">mikel.egana@ehu.eus</a></p>
        <img src="../ShowerTemplate/pictures/ehu.png" alt="UPV/EHU ingenieros San Mames" height="25%" style="border: 1px solid #555;">
    </section>

    <section class="slide">
        <h2>MongoDB</h2>
        <p><a href="https://github.com/mikel-egana-aranguren/ABD">https://github.com/mikel-egana-aranguren/ABD</a></p>
        <img src="../ShowerTemplate/pictures/by.png" alt="Creative Commons BY" height="10%">
    </section>

    <section class="slide">
        <h2>MongoDB</h2>
        <p><a href="https://www.mongodb.com/">https://www.mongodb.com/</a></p>
        <p>BD NoSQL orientada a documentos (JSON)</p>
        <p>Su nombre viene de la palabra Humongous (“gigantesco”)</p>
    </section>

    <section class="slide">
        <h2>MongoDB</h2>
        <ul>
            <li>MongoDB Community Edition: Versión libre</li>
            <li>MongoDB Enterprise: Versión comercial</li>
            <li>MongoSH: cliente Shell</li>
            <li>Atlas: Servicio en la nube</li>
            <li>Herramientas adicionales: Compass, Atlas CLI, VS Code Plugin, ...</li>
            <li><a href="https://www.mongodb.com/docs/">Documentación</a></li>
        </ul>
    </section>

    <section class="slide">
        <h2>Instalación Ubuntu</h2>
        <ol>
            <li>Importar clave GPG (Instalar gpg, curl)</li>
            <li>Crear archivo sources.list (24.04, 22.04, 20.04)</li>
            <li>Recargar los paquetes disponibles en APT</li>
            <li>Instalar mediante APT</li>
        </ol>
    </section>



    <section class="slide">
        <h2>Instalación Docker</h2>
        <ol>
            <li><a href="https://hub.docker.com/">https://hub.docker.com/</a></li>
            <li>mongodb/mongodb-community-server</li>
            <li>docker pull mongodb/mongodb-community-server</li>
            <li>docker run --name mongodb -p 27017:27017 -d mongodb/mongodb-community-server:latest</li>
        </ol>
    </section>



    <section class="slide">
        <h2>Estructura de datos</h2>
        <p><img  style="border: 1px solid #555;"  src="pictures-abd-01/modelo.svg" alt="Estructura MongoDB" width="80%"></p>
    </section>

    <section class="slide">
        <h2>Estructura de datos</h2>
        <p>Un documento se organiza en formato <a href="https://datatracker.ietf.org/doc/html/rfc4627">JSON</a> (JavaScript Object Notation): Internamente se almacena en formato <a href="https://bsonspec.org/">Binary JSON</a> (BSON)</p>
        <p>Cada dato como clave valor</p>
    </section>

    <section class="slide">
        <h2>Estructura de datos</h2>
        <p><img  style="border: 1px solid #555;"  src="pictures-abd-01/json.svg" alt="Estructura MongoDB - JSON" width="60%"></p>
    </section>

    <section class="slide">
        <h2>Estructura de datos</h2>
        <p>Equivalencia aproximada con modelo relacional:
            <ul>
                <li>Tabla - colección</li>
                <li>Fila - documento</li>
                <li>Columna - clave</li>
                <li>Joins - integrados en documentos</li>
            </ul>
        </p>
    </section>

    <section class="slide">
        <h2>Estructura de datos</h2>
        <p>Diferencias principales con modelo relacional:
            <ul>
                <li>No todos los documentos tienen por qué tener las mismas claves</li>
                <li>No es necesario definir relaciones explícitas entre documentos</li>
            </ul>
        </p>
    </section>

    <section class="slide">
        <h2>Directorios importantes</h2>
            <ul>
                <li>/var/log/mongodb/</li>
                <li>/var/lib/mongodb/</li>
            </ul>
    </section>

    <section class="slide">
        <h2>Comandos</h2>
        <ul>
            <li>MongoSH: <pre>$ mongosh</pre></li>
            <li>Mostrar BBDD existentes: <pre>> show dbs</pre></li>
            <li>Mostrar BBDD en uso: <pre>> db</pre></li>

        </ul>
    </section>

    <section class="slide">
        <h2>Comandos</h2>
        <ul>
            <li>Crear/meterse en DB: <pre>> use nombre-BBDD</pre></li>
            <li>Limpiar la pantalla: <pre>> cls</pre></li>
            <li>Tabular!!!! <pre>> db.</pre></li>
        </ul>
    </section>

    <section class="slide">
        <h2>Comandos</h2>
        Crear coleccion vacia (! NoSQL):
        <ul>
            <li> <pre>> use tienda</pre></li>
            <li> <pre>> db.createCollection("clientes")</pre></li>
            <li> <pre>> show dbs</pre></li>
            <li> <pre>> show collections</pre></li>
        </ul>
    </section>

    <section class="slide">
        <h2>Comandos</h2>
        Crear coleccion con un documento:
        <ul>
            <li> <pre>> use tienda</pre></li>
            <li> <pre>> db.[coleccion].insertOne([documento])</pre></li>
            <li> <pre>> db.clientes.insertOne({"nombre":"mikel"})</pre></li>

        </ul>
    </section>

    <section class="slide">
        <h2>Comandos</h2>
        <ul>
            <li>Cada documento tiene un identificador único que se asigna automáticamente en su creación</li>
            <li>Asignar ID de forma manual: <pre>> db.clientes.insertOne ({ _id:1 , nombre:"josu" }) </pre></li>
            <li>Mostrar todos los documentos: <pre>> db.[nombre-colección].find()</pre></li>
        </ul>
    </section>

    <section class="slide">
        <h2>Comandos</h2>
        <p>Insertar múltiples documentos en una colección: <pre>> db.[nombre-colección].insertMany( [array-docs] )</pre></p>
        <p><pre>> db.departamentos.insertMany([{"nombre":"Contabilidad","empleados":45,"responsable":"Rosa","edificio":"A"},{"nombre":"Almacen","empleados":5}])</pre></p>
    </section>

    <section class="slide">
        <h2>Comandos</h2>
        <ul>

            <li>Mostrar los documentos que encajen con un patrón: <pre>> db.[nombre-colección].find([patrón])</pre></li>
            <li>Encontrar el 1er documento que encaje con un patrón: <pre>> db.[nombre-colección].findOne([patrón])</pre></li>
        </ul>
    </section>

    <section class="slide">
        <h2>Comandos</h2>
        <ul>
            <li>Condicion: {}</li>
            <li>Buscar en la colección libros los libros con editorial “Biblio”: <pre>> db.libros.find({editorial:"Biblio"})</pre></li>
            <li>Buscar en la colección libros los libros con editorial “Biblio” y cantidad de 12: <pre>> db.libros.find({editorial:"Biblio", cantidad: 12})</pre></li>
        </ul>
    </section>

    <section class="slide">
        <h2>Comandos</h2>
        <ul>
            <li>{columna: {operador:valor}, ...}</li>
            <li>Operadores de comparación (eq,ne,gt,gte,lt,lte): <pre>> db.libros.find({editorial:"Biblio", cantidad: { $gt: 20 }})</pre></li>
            <li>Expresiones regulares: <pre>> db.libros.find({editorial:"Biblio", titulo : /Don.*/})</pre></li>
        </ul>
    </section>

    <section class="slide">
        <h2>Comandos</h2>
        <ul>
            <li>AND</li>
            <li><pre>> db.libros.find({condicion1,condicion2,condicion3})</pre></li>
            <li><pre>> db.libros.find({$and : [{condicion1},{condicion2},{condicion3}]})</pre></li>
            <li><pre>> db.libros.find({ precio : {$gt: 25}, cantidad : {$lt : 25}})</pre></li>
        </ul>
    </section>

    <section class="slide">
        <h2>Comandos</h2>
        <ul>
            <li>OR</li>
            <li><pre>> db.libros.find({ $or : [ {precio : {$gt: 25}}, {cantidad : {$lt : 25}}]})</pre></li>
        </ul>
    </section>

    <section class="slide">
        <h2>Comandos</h2>
        <ul>
            <li>Campos a mostrar: <pre>{ campoAMostrar: 1, campoAOcultar: 0}</pre></li>
            <li><pre>> db.libros.find({editorial: "Planeta"},{titulo:1, _id:0,editorial:1})</pre></li>
        </ul>
    </section>

    <section class="slide">
------------------------------
    </section>

















    <section class="slide">
        <h2>Comandos</h2>
        <ul>
            <li>Eliminar el 1er documento que encaje con patrón: <pre>> db.[nombre-colección].deleteOne([patrón])</pre></li>
            <li>Eliminar los documentos que encajen con patrón: <pre>> db.[nombre-colección].deleteMany([patrón])</pre></li>
            <li>Eliminar todos los documentos de una colección: <pre>> db.[nombre-colección].deleteMany( {} )</pre></li>
        </ul>
    </section>

    <section class="slide">
        <h2>Comandos</h2>
        <ul>
            <li>Modificar documentos en una colección: <pre>> db.[nombre-colección].updateMany([patrón-busq], {$set: [cambios]})</pre></li>
            <li>Para los clientes cuyo DNI sea 22233, actualizar su nombre a “Nagore”: <pre>> db.clientes.updateMany({ DNI: 22233 }, {$set:{ nombre: "Nagore" } })</pre></li>
        </ul>
    </section>

    <section class="slide">
        <h2>Comandos</h2>
        <ul>
            <li>Reemplazar un documento por otro: <pre>> db.[nombre-colección].replaceOne([patrón-busq], [nuevo-doc] )</pre></li>
        </ul>
    </section>

    <section class="slide">
        <h2>Comandos</h2>
        <ul>
            <li>Mostrar colecciones en una BD: <pre>> show collections</pre></li>
            <li>Eliminar una colección completa: <pre>> db.[nombre-colección].drop()</pre></li>
            <li>Eliminar una BD: <pre>> db.dropDatabase()</pre></li>
        </ul>
    </section>

    <section class="slide">
        <h2>Relaciones</h2>
        <p>Un documento puede tener documentos embebidos o listados</p>
        <p><img  style="border: 1px solid #555;"  src="pictures-abd-01/embed_listado.png" alt="Crear BD" width="60%"></p>
    </section>

    <section class="slide">
        <h2>Relaciones</h2>
        <p>Normalmente:
            <ul>
                <li>Varias colecciones, cada un representa una entidad del contexto: clientes, productos, pedidos</li>
                <li>Relaciones entre los datos de diferentes entidades</li>
            </ul>
        </p>
        <p>MongoDB no proporciona una técnica concreta para definir relaciones entre colecciones: las debemos definir nosotros</p>
    </section>

    <section class="slide">
        <h2>Relaciones</h2>
        <p>Documentos embebidos</p>
        <p>Utilizar campos concretos como referencia</p>
    </section>

    <section class="slide">
        <h2>Documentos embebidos</h2>
        <p><img  style="border: 1px solid #555;"  src="pictures-abd-01/embebido.png" alt="Documentos embebidos" width="20%"></p>
    </section>

    <section class="slide">
        <h2>Documentos embebidos</h2>
        <p>Adecuado para datos que no se solapan/repiten</p>
        <p>(+) Los datos se agrupan lógicamente</p>
        <p>(-) Puede generar duplicidades que debemos gestionar</p>
    </section>

    <section class="slide">
        <h2>Referencias</h2>
        <p><img  style="border: 1px solid #555;"  src="pictures-abd-01/Referencias.png" alt="Referencias" width="50%"></p>
    </section>

    <section class="slide">
        <h2>Referencias</h2>
        <p>Adecuado para datos que se referencien en diferentes colecciones</p>
        <p>(+) Elimina posibles duplicidades</p>
        <p>(-) Más complejo de gestionar</p>
        <p>(-) Requiere agregaciones para obtener datos relacionados</p>
    </section>

    <section class="slide">
        <h2>Referencias</h2>
        <p>Relación entre los datos 1 a N: un cliente puede tener múltiples direcciones, una dirección pertenece sólo a 1 cliente</p>
        <p><img  style="border: 1px solid #555;"  src="pictures-abd-01/ref_1_n.png" alt="Referencias 1 N" width="60%"></p>
    </section>

    <section class="slide">
        <h2>Referencias</h2>
        <p>Relación entre los datos N a N: un cliente puede comprar múltiples productos, un producto puede ser comprado por múltiples clientes</p>
        <p><img  style="border: 1px solid #555;"  src="pictures-abd-01/ref_n_n.png" alt="Referencias 1 N" width="60%"></p>
    </section>

    <section class="slide">
        <h2>Referencias o documentos embebidos</h2>
        <p>Documentos embebidos:
            <ul>
                <li>Datos que estén fuertemente relacionados y que no estén duplicados</li>
                <li>Relaciones 1 a 1: un cliente tendrá sólo una dirección asociada</li>
                <li>Relaciones 1 a N donde no haya duplicidades</li>
            </ul>
        </p>
    </section>

    <section class="slide">
        <h2>Referencias o documentos embebidos</h2>
        <p>Referencias
            <ul>
                <li>Datos de entidades independientes pero relacionadas</li>
                <li>Relaciones 1 a N</li>
                <li>Relaciones N a N</li>
            </ul>
        </p>
    </section>

    <section class="slide">
        <h2>Relaciones</h2>
        <p>Combinacion mediante agregacion ("Join")</p>
        <p><img  style="border: 1px solid #555;"  src="pictures-abd-01/combi.png" alt="Referencias 1 N" width="80%"></p>
    </section>

    <section class="slide">
        <h2>Agregacion mediante $lookup</h2>
        <p>Ejemplo: Crear una colección que contenga los datos de los pedidos combinados con los datos de los clientes</p>
        <p><img  style="border: 1px solid #555;"  src="pictures-abd-01/lookup.png" alt="Referencias 1 N" width="80%"></p>
    </section>

    <section class="slide">
        <h2>Esquemas</h2>
        <p>Es posible gestionar BBDD en MongoDB sin definir ningún tipo de estructura</p>
        <p>Pero en algunas situaciones puede que queramos controlar los datos de forma automática: P.e. que todos los documento de una colección “productos” tienen un campo numérico “precio”</p>
    </section>

    <section class="slide">
        <h2>Esquemas (Fuente: M. Schwarzmüller)</h2>
        <p><img  style="border: 1px solid #555;"  src="pictures-abd-01/esquemas.png" alt="Referencias 1 N" width="80%"></p>
    </section>

    <section class="slide">
        <h2>Esquemas</h2>
        <p>Se puede definir la estructura que deben cumplir los documentos de una colección</p>
        <p>Un esquema verifica cada documento insertado en una colección y genera un aviso/error si es incorrecto</p>
    </section>

    <section class="slide">
        <h2>Esquemas</h2>
        <p>validationLevel: Controla cómo de estricta es la validación
            <ul>
                <li>strict (valor por defecto): Se comprueba toda inserción y modificación</li>
                <li>moderate: Las modificaciones a documentos ya existentes no se comprueban</li>
            </ul>
        </p>
    </section>

    <section class="slide">
        <h2>Esquemas</h2>
        <p>validationAction: Indica qué hacer cuando un documento no cumple el esquema
            <ul>
                <li>error (valor por defecto): Se emite un error y se impide la inserción</li>
                <li>warn: Se escribe un aviso en el log de MongoDB y se permite la inserción</li>
            </ul>
        </p>
    </section>

    <section class="slide">
        <h2>Esquemas</h2>
        <p><img src="pictures-abd-01/validator.png" alt="Validator" width="80%"></p>
    </section>

    <section class="slide">
        <h2>Esquemas</h2>
        <p>Mostrar el esquema de una colección: <pre>> db.getCollectionInfos({name: "marcas"})</pre></p>
        <p>Modificar el esquema de una colección: 
            <img  src="pictures-abd-01/change_validator.png" alt="Change Validator" width="80%">
        </p>
    </section>

    <section class="slide">
        <h2>Esquemas</h2>
        <p>Si validationAction es “warn”, el resultado se escribe en el log de MongoDB, por defecto en /var/log/mongodb/mongod.log</p>
    </section>

    <section class="slide">
        <h2>Esquemas</h2>
        <p><img  src="pictures-abd-01/data_types.png" alt="Validator" width="80%"></p>
    </section>

    <!-- FOOTER -->

    <footer class="badge">
        <a href="https://github.com/mikel-egana-aranguren/ShowerTemplate">Fork me on GitHub</a>
    </footer>

    <div class="progress"></div>

    <script src="../ShowerTemplate/shower/shower.js"></script>
    <!-- Copyright © 3000 Yours Truly, Famous Inc. -->

</body>
</html>
